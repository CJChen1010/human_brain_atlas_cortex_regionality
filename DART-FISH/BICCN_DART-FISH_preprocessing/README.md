This repository is used to document custom codes in Zhang lab to preprocess BICCN DART-FISH images. To run the custom codes, we install the required python packages in conda virtual environment, "DF_201012" and install SimpleElastix. 

# Create virtual environment and install required packages
Run these commands to build SimpleElastix in the DF_201012 environment.
```
mkdir ~/path/to/SimpleElastix_201012
cd ~/path/to/SimpleElastix_201012
mv DF201012.ymal ~/path/to/SimpleElastix_201012
```
Create and activate DF_201012 virtual environment
```
conda env create -f DF_201012_env.yml
conda activate DF_201012
```
Clone and build SimpleElastix
```
git clone https://github.com/SuperElastix/SimpleElastix
mkdir build
cd build
PYTHON_LIBRARY=~/anaconda3/envs/DF_201012/bin/python
cmake ../SimpleElastix/SuperBuild
make -j8
cd SimpleITK-build/Wrapping/Python
python Packaging/setup.py install --user
```
Download  FIJI and model weights for cellpose
Download FIJI from https://downloads.imagej.net/fiji/latest/fiji-latest-linux64-jdk.zip and unzip it.
Cellpose's weights can be downloaded using the function "download_model_weights" in cellpose.models.

# Set up the structure of directories
All data and codes to process DART-FISH images are kept in the same directory with the following structure of directories. 
1. 0_Raw
0_Raw directory contails all tiff files from one DART-FISH experiments. The examples below shows the output tiff files from Leica SP8 microscope. Each tiff file is named after "round_name1"_s*_z*_ch*.tif format, where s is the field of view (FOV) number, z the number for z-stack, and ch the fluorescent channel.
2. 1_Projected
1_Projected will contain all maximal intensity projected images.
3. 2_Registered
2_Registered will contain images that are registered to images in the reference imaging cycle.
4. 3_Decoded
3_Decoded will contiain tables that include spots decoded by SpaceTx StarFish
5. 4_CellAssigment
4_CellAssigment will contain the segmentation mask by cellpose and cell-by-gene matrix.
6. Codes
Codes directory contains all codes used to process DART-FISH images. The subfolder "code_lib" contains classes that are used during data processing while "_codebook" contains codebook encoding each gene. The codebook is generated by running "CodebookGenerator_201017.py". To generate a codebook successfully, we need a gene-barcode file that is located at "_codebook/TB12k_Mar2018_V7_noAnchor.txt". In addition, other important inputs are the length of the codewords and the number of off-cycles. The codebook will synthesized in .json format and will be saved in "_codebook/". It should contain all the empty barcodes that have two off cycles and are not uni-color. Should change directory to the "Codes" directory to run each python code step-by-step.
```
Experiment    
|___0_Raw
│   │___"Round_name1"
│   │       "round_name1"_s*_z*_ch00.tif
|   |       "round_name1"_s*_z*_ch01.tif
|   |       "round_name1"_s*_z*_ch02.tif
|   |       "round_name1"_s*_z*_ch03.tif
│   |        ...
|   |___"Round_name2"
│   │       "round_name1"_s*_z*_ch00.tif
|   |       "round_name1"_s*_z*_ch01.tif
|   |       "round_name1"_s*_z*_ch02.tif
|   |       "round_name1"_s*_z*_ch03.tif
│   |        ...
|___1_Projected
|   │___"FOV001"    
|   │       MIP_"round_name1"_FOV001_ch00.tif
|   |       MIP_"round_name1"_FOV001_ch01.tif
|   |       MIP_"round_name1"_FOV001_ch02.tif
|   |       MIP_"round_name1"_FOV001_ch03.tif
|   |       ...
|   |___"FOV002"
|   |       ...
|___2_Registered
|___3_Decoded
|___4_CellAssignment
|___Codes
|   |___"code_lib"
|   |___"_codebook"
```
# Maximal intensity projection and image registration
The AlignerDriver.py script is used to maximal intensity project z-stack images to 2D images and register the 2D images to the reference image cycle. After maximal intensity projection, the script algins the images at the brightfield channel of each cycle to a reference cycle to learn the affine transformation parameters. Then, the parameters are used t0 apply transformation to all other fluorescent channels. The inputs in the Aligner.py are the names of the directories in O_Raw, the number of FOVs in the experiment, the reference cycle and the reference channel for registration. The outputs include the maximal intensity projected images stored in "1_Projected" stratefied by FOVs and the registered images stored in "2_Registered" stratified by FOVs.
# Image stitching
The StitchDriver.py script is used to stitch registered images in "2_Registered". It's a wrapper for ImageJ's Grid/Collection Stitching plugin. The imputs are rounds to be stitched, the reference cycle and channels, and the path to ImageJ's executables. The output stitched images is stored in the 2_Registered/stitched directory. The output "registration_reference_coordinates.csv" file will be used to convert data to the Starfish format.
# Starfish decoding
The starfishDARTFISHpipeline.py is used to decode spots in each FOV. Proper bcmag (barcode magnitude) values need to be tuned for images with various fluorescent intensities . Generally, the higher the bcmag, dimmer signals are discarded. The ouput of the decoded spots are stored as starfish_table_bcmagxx_FOVxxx.csv in the 3_Decoded/output_Starfish/bcmagxx directory.
# Merging spots from all FOVs and filtering
The 201019_CombineFOVs.py script is used to remove duplicated spots at overlapping regions between FOVs. Also, it finds a reasonable distance to barcode to keep high confidence spots and filter out low confidence ones. The main input is "emptyFractionThreshold". The code finds a distance cutoff in a way that only "emptyFractionThresh" of all spots with smaller distances than this cutoff are empty barcodes. The output is all_spots_filtered.tsv stored in the 3_Decoded/output_Starfish/ directory.
# Nucleus segmentation and assigment of decoded spots to nuclei
The segmentation_driver_201019.py is used to segment cell nuclei based on nuclear staining images and assign spots to nuclei in proximity. It uses Cellpose to segment the stitched nuclear staining image. Then, it assigns each spot to the closest nuclear boundary and generates the cell-by-gene matrix. The segmentation mask is save in the 4_CellAsignment directory. 

